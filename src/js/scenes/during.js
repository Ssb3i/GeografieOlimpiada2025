/**
 * During Earthquake Scene - Drop, Cover, Hold On Actions
 */

import { UIHelpers, EducationalContent, audioHelper } from '../utils/helpers.js';
// import { gameAudio } from '../../assets/audio/sounds.js';
// import { ParticleHelper } from '../utils/particles.js';

export class DuringScene {
    constructor(gameState) {
        this.gameState = gameState;
        this.sceneName = 'during';
        this.currentScenario = null;
        this.reactionTime = 0;
        this.scenarios = this.createScenarios();
        this.timer = null;
        this.earthquakeActive = false;
    }

    /**
     * Play earthquake rumbling sound effect
     */
    playEarthquakeSound() {
        // Only play if audioHelper is available and not disabled
        if (typeof audioHelper !== 'undefined' && audioHelper.playEarthquake) {
            audioHelper.playEarthquake(this.currentScenario.maxTime);
        } else {
            // Fallback: just log
            console.log('Playing earthquake sound effect (audio disabled)');
        }
    }

    /**
     * Create different earthquake scenarios
     */
    createScenarios() {
        return [
            {
                id: 'indoor-office',
                title: 'Scoala - Etajul 3',
                description: 'Esti la scoala c√¢nd √Æncepe sƒÉ se zguduie pƒÉm√¢ntul.',
                correctActions: ['drop', 'cover-desk', 'hold-on'],
                wrongActions: ['run-outside', 'doorway', 'elevator'],
                environment: 'inauntru',
                maxTime: 10000 // 10 secunde
            },
            {
                id: 'indoor-home',
                title: 'Sufrageria de acasƒÉ',
                description: 'Te ui»õi la televizor c√¢nd sim»õi o zguduire puternicƒÉ.',
                correctActions: ['drop', 'cover-table', 'hold-on'],
                wrongActions: ['run-outside', 'stand-still', 'hide-doorway'],
                environment: 'inauntru',
                maxTime: 8000
            },
            {
                id: 'outdoor-street',
                title: 'Pe stradƒÉ √Æn ora»ô',
                description: 'Mergi pe jos c√¢nd √Æncepe cutremurul.',
                correctActions: ['move-away-buildings', 'drop-open-area', 'protect-head'],
                wrongActions: ['run-into-building', 'stand-under-sign', 'panic-run'],
                environment: 'afara',
                maxTime: 12000
            },
            {
                id: 'driving-car',
                title: 'Esti pe autostradƒÉ',
                description: 'E»ôti in masina c√¢nd sim»õi cƒÉ ma»ôina se zguduie.',
                correctActions: ['pull-over', 'stay-in-car', 'avoid-bridges'],
                wrongActions: ['keep-driving', 'get-out-car', 'stop-under-bridge'],
                environment: 'vehicul',
                maxTime: 15000
            }
        ];
    }

    /**
     * Render the scene
     */
    render(container) {
        this.container = container;
        container.innerHTML = `
            <div class="scene-during">
                <div class="scene-header">
                    <h2>‚ö° √én timpul cutremului: Ac»õioneazƒÉ rapid!</h2>
                    <p>ExerseazƒÉ rƒÉspunsurile corecte √Æn scenarii de cutremur. Reac»õioneazƒÉ rapid »ôi alege ac»õiunile potrivite!</p>
                </div>

                <div class="scenario-selector" id="scenario-selector">
                    <h3>Alege un scenariu pentru exersare:</h3>
                    <div class="scenario-grid">
                        ${this.scenarios.map(scenario => `
                            <div class="scenario-card" data-scenario="${scenario.id}">
                                <h4>${scenario.title}</h4>
                                <p>${scenario.description}</p>
                                <div class="scenario-type">${scenario.environment.toUpperCase()}</div>
                                <button class="start-scenario-btn" data-scenario="${scenario.id}">√éncepe scenariul</button>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="scenario-player hidden" id="scenario-player">
                    
                    <div class="scenario-environment" id="scenario-environment">
                        <!-- Mediul va fi generat dinamic -->
                    </div>
                    
                    <div class="action-panel" id="action-panel">
                        <!-- Timer removed -->
                        <div class="actions-grid" id="actions-grid">
                            <!-- Butoane de ac»õiune generate dinamic -->
                        </div>
                    </div>
                    
                    <div class="feedback-panel hidden" id="feedback-panel">
                        <div class="feedback-content">
                            <h3 id="feedback-title">Bravo!</h3>
                            <div id="feedback-message"></div>
                            <div class="scenario-stats">
                                <div>Timp de reac»õie: <span id="reaction-time">0.0s</span></div>
                                <div>Scor: <span id="scenario-score">0</span> puncte</div>
                            </div>
                            <button class="btn btn--primary" id="next-scenario">√éncearcƒÉ alt scenariu</button>
                            <button class="btn btn--secondary" id="replay-scenario">RepetƒÉ acest scenariu</button>
                        </div>
                    </div>
                </div>

                <div class="educational-panel text-grey">
                    <h3>üéØ Aminte»ôte-»õi: Culcat, Acoperit, »öine-te!</h3>
                    <div class="action-guide">
                        <div class="action-step">
                            <strong>1. CULCAT:</strong> Pune-te imediat pe m√¢ini »ôi genunchi
                        </div>
                        <div class="action-step">
                            <strong>2. ACOPERIT:</strong> AdƒÉposte»ôte-te sub o masƒÉ sau birou solid
                        </div>
                        <div class="action-step">
                            <strong>3. »öINE-TE:</strong> »öine-te de adƒÉpost »ôi protejeazƒÉ-»õi capul
                        </div>
                    </div>
                </div>
            </div>
        `;

        this.initializeScenarios();
    }

    /**
     * Initialize scenario selection and gameplay
     */
    initializeScenarios() {
        // Scenario selection
        const scenarioCards = document.querySelectorAll('.start-scenario-btn');
        scenarioCards.forEach(btn => {
            btn.addEventListener('click', (e) => {
                const scenarioId = e.target.dataset.scenario;
                // gameAudio.playClick();
                this.startScenario(scenarioId);
            });
        });

        // Feedback panel buttons
        document.getElementById('next-scenario').addEventListener('click', () => {
            // gameAudio.playClick();
            this.returnToScenarioSelection();
        });

        document.getElementById('replay-scenario').addEventListener('click', () => {
            if (this.currentScenario) {
                // gameAudio.playClick();
                this.startScenario(this.currentScenario.id);
            }
        });
    }

    /**
     * Start a specific earthquake scenario
     */
    startScenario(scenarioId) {
        this.currentScenario = this.scenarios.find(s => s.id === scenarioId);
        if (!this.currentScenario) return;

        // Hide scenario selector and show player
        document.getElementById('scenario-selector').classList.add('hidden');
        document.getElementById('scenario-player').classList.remove('hidden');

        // Reset state
        this.earthquakeActive = false;
        this.reactionTime = 0;
        
        // Start the earthquake simulation
        this.startEarthquakeSimulation();
    }


    /**
     * Start the earthquake simulation
     */
    startEarthquakeSimulation() {
        this.earthquakeActive = true;
        this.reactionTime = Date.now();

        // Create environment
        this.createEnvironment();
        
        // Start shaking animation
        document.body.classList.add('shake');
        
        // Add particle effects for earthquake (disabled for now)
        // const environment = document.getElementById('scenario-environment');
        // ParticleHelper.earthquakeEffect(environment);
        
        // Create action buttons
        this.createActionButtons();
        
        // Timer removed
        // this.startTimer();
        
        // Play earthquake sound effect
        this.playEarthquakeSound();
    }

    /**
     * Create the environment based on scenario
     */
    createEnvironment() {
        const environment = document.getElementById('scenario-environment');
        const scenario = this.currentScenario;

        let environmentHTML = '';

        switch (scenario.environment) {
            case 'indoor':
                environmentHTML = `
                    <div class="indoor-environment">
                        <div class="room-layout">
                            <div class="furniture desk" id="desk">üè¢ Desk</div>
                            <div class="furniture table" id="table">ü™ë Table</div>
                            <div class="furniture bookshelf" id="bookshelf">üìö Bookshelf</div>
                            <div class="door" id="door">üö™ Door</div>
                            <div class="window" id="window">ü™ü Window</div>
                        </div>
                        <div class="person" id="person">üßë‚Äçüíº</div>
                    </div>
                `;
                break;

            case 'outdoor':
                environmentHTML = `
                    <div class="outdoor-environment">
                        <div class="street-layout">
                            <div class="building" id="building1">üè¢ Building</div>
                            <div class="building" id="building2">üè¨ Store</div>
                            <div class="sign" id="sign">ü™ß Sign</div>
                            <div class="open-area" id="open-area">üü© Open Area</div>
                            <div class="power-line" id="power-line">‚ö° Power Line</div>
                        </div>
                        <div class="person" id="person">üö∂‚Äç‚ôÇÔ∏è</div>
                    </div>
                `;
                break;

            case 'vehicle':
                environmentHTML = `
                    <div class="vehicle-environment">
                        <div class="road-layout">
                            <div class="road" id="road">üõ£Ô∏è Highway</div>
                            <div class="bridge" id="bridge">üåâ Bridge</div>
                            <div class="shoulder" id="shoulder">üöó Shoulder</div>
                            <div class="overpass" id="overpass">üèóÔ∏è Overpass</div>
                        </div>
                        <div class="car" id="car">üöó</div>
                    </div>
                `;
                break;
        }

        environment.innerHTML = environmentHTML;
    }

    /**
     * Create action buttons for the scenario
     */
    createActionButtons() {
        const actionsGrid = document.getElementById('actions-grid');
        const scenario = this.currentScenario;
        
        // Combine correct and wrong actions
        const allActions = [...scenario.correctActions, ...scenario.wrongActions];
        
        // Shuffle actions
        const shuffledActions = allActions.sort(() => Math.random() - 0.5);

        actionsGrid.innerHTML = '';
        
        shuffledActions.forEach(actionId => {
            const actionData = this.getActionData(actionId);
            const button = document.createElement('button');
            button.className = 'action-btn';
            button.innerHTML = `
                <div class="action-icon">${actionData.icon}</div>
                <div class="action-text">${actionData.text}</div>
            `;
            
            button.addEventListener('click', () => {
                // gameAudio.playClick();
                this.handleActionClick(actionId);
            });
            
            actionsGrid.appendChild(button);
        });
    }

    /**
     * Get action data for button display
     */
    getActionData(actionId) {
        const actions = {
            'drop': { icon: '‚¨áÔ∏è', text: 'CulcƒÉ-te la pƒÉm√¢nt' },
            'cover-desk': { icon: 'üè¢', text: 'AdƒÉposte»ôte-te sub birou' },
            'cover-table': { icon: 'ü™ë', text: 'AdƒÉposte»ôte-te sub masƒÉ' },
            'hold-on': { icon: 'ü§≤', text: '»öine-te bine' },
            'protect-head': { icon: 'üõ°Ô∏è', text: 'ProtejeazƒÉ-»õi capul' },
            'move-away-buildings': { icon: 'üèÉ‚Äç‚ôÇÔ∏è', text: '√éndepƒÉrteazƒÉ-te de clƒÉdiri' },
            'drop-open-area': { icon: 'üü©', text: 'CulcƒÉ-te √Æntr-o zonƒÉ deschisƒÉ' },
            'pull-over': { icon: 'üöó', text: 'Trage pe dreapta √Æn siguran»õƒÉ' },
            'stay-in-car': { icon: 'üöó', text: 'RƒÉm√¢i √Æn ma»ôinƒÉ' },
            'avoid-bridges': { icon: 'üö´', text: 'EvitƒÉ podurile' },
            'run-outside': { icon: 'üèÉ‚Äç‚ôÇÔ∏è', text: 'AleargƒÉ afarƒÉ' },
            'doorway': { icon: 'üö™', text: 'Stai √Æn u»ôƒÉ' },
            'elevator': { icon: 'üõó', text: 'Folose»ôte liftul' },
            'stand-still': { icon: 'üßç', text: 'Stai nemi»ôcat' },
            'hide-doorway': { icon: 'üö™', text: 'Ascunde-te √Æn u»ôƒÉ' },
            'run-into-building': { icon: 'üè¢', text: 'IntrƒÉ √Æntr-o clƒÉdire' },
            'stand-under-sign': { icon: 'ü™ß', text: 'Stai sub un semn' },
            'panic-run': { icon: 'üò±', text: 'Fugi panicat' },
            'keep-driving': { icon: 'üöó', text: 'ContinuƒÉ sƒÉ conduci' },
            'get-out-car': { icon: 'üö™', text: 'Ie»ôi din ma»ôinƒÉ' },
            'stop-under-bridge': { icon: 'üåâ', text: 'Opre»ôte sub pod' }
        };

        return actions[actionId] || { icon: '‚ùì', text: 'Ac»õiune necunoscutƒÉ' };
    }

    /**
     * Handle action button click
     */
    handleActionClick(actionId) {
        const isCorrect = this.currentScenario.correctActions.includes(actionId);
        this.reactionTime = Date.now() - this.reactionTime;
        
        // Stop earthquake
        this.stopEarthquake();
        
        // Calculate score
        const score = this.calculateScore(isCorrect, this.reactionTime);
        this.gameState.addScore(this.sceneName, score);
        
        // Record action
        this.gameState.recordAction(this.sceneName, {
            type: 'earthquake-response',
            scenario: this.currentScenario.id,
            action: actionId,
            correct: isCorrect,
            reactionTime: this.reactionTime,
            score: score
        });

        // Show feedback
        this.showFeedback(isCorrect, actionId, score);
    }

    /**
     * Stop earthquake simulation
     */
    stopEarthquake() {
        this.earthquakeActive = false;
        document.body.classList.remove('shake');
        // Timer logic removed
        // if (this.timerInterval) {
        //     clearInterval(this.timerInterval);
        // }
        // Hide action panel
        document.getElementById('action-panel').classList.add('hidden');
    }

    /**
     * Calculate score based on performance
     */
    calculateScore(isCorrect, reactionTime) {
        if (!isCorrect) return 0;

        const baseScore = 50;
        const timeBonus = Math.max(0, 30 - Math.floor(reactionTime / 1000) * 5);
        return baseScore + timeBonus;
    }

    /**
     * Show feedback after action
     */
    showFeedback(isCorrect, actionId, score) {
        const feedbackPanel = document.getElementById('feedback-panel');
        const feedbackTitle = document.getElementById('feedback-title');
        const feedbackMessage = document.getElementById('feedback-message');
        const reactionTimeDisplay = document.getElementById('reaction-time');
        const scoreDisplay = document.getElementById('scenario-score');

        // Update displays
        reactionTimeDisplay.textContent = `${(this.reactionTime / 1000).toFixed(1)}s`;
        scoreDisplay.textContent = score;

        if (isCorrect) {
            feedbackTitle.textContent = '‚úÖ RƒÉspuns corect!';
            feedbackTitle.className = 'feedback-success';
            feedbackMessage.innerHTML = `
                <p>Ai ales ac»õiunea corectƒÉ pentru acest scenariu de cutremur.</p>
                <div class="correct-explanation">
                    ${this.getActionExplanation(actionId, true)}
                </div>
            `;
            if (typeof audioHelper !== 'undefined' && audioHelper.playSuccess) {
                audioHelper.playSuccess();
            }
            
            // Add celebration particles for correct answer (disabled for now)
            // ParticleHelper.celebrationEffect(feedbackPanel);
        } else if (actionId === 'timeout') {
            feedbackTitle.textContent = '‚è∞ Timpul a expirat!';
            feedbackTitle.className = 'feedback-warning';
            feedbackMessage.innerHTML = `
                <p>Trebuie sƒÉ reac»õionezi rapid √Æn timpul unui cutremur. ExerseazƒÉ pentru a-»õi √ÆmbunƒÉtƒÉ»õi timpul de reac»õie.</p>
                <div class="correct-actions">
                    <strong>Ac»õiuni corecte pentru acest scenariu:</strong>
                    <ul>
                        ${this.currentScenario.correctActions.map(action => 
                            `<li>${this.getActionData(action).text}</li>`
                        ).join('')}
                    </ul>
                </div>
            `;
        } else {
            feedbackTitle.textContent = '‚ùå Ac»õiune gre»ôitƒÉ';
            feedbackTitle.className = 'feedback-error';
            feedbackMessage.innerHTML = `
                <p>AceastƒÉ ac»õiune poate fi periculoasƒÉ √Æn timpul unui cutremur.</p>
                <div class="wrong-explanation">
                    ${this.getActionExplanation(actionId, false)}
                </div>
                <div class="correct-actions">
                    <strong>Op»õiuni mai bune ar fi:</strong>
                    <ul>
                        ${this.currentScenario.correctActions.map(action => 
                            `<li>${this.getActionData(action).text}</li>`
                        ).join('')}
                    </ul>
                </div>
            `;
            if (typeof audioHelper !== 'undefined' && audioHelper.playError) {
                audioHelper.playError();
            }
        }

        feedbackPanel.classList.remove('hidden');
    }

    /**
     * Get explanation for an action
     */
    getActionExplanation(actionId, isCorrect) {
        const explanations = {
            'drop': 'Culcatul pe m√¢ini »ôi genunchi te protejeazƒÉ de a fi dobor√¢t »ôi de obiectele care cad.',
            'cover-desk': 'AdƒÉpostirea sub un birou solid te protejeazƒÉ de resturile care cad.',
            'cover-table': 'O masƒÉ solidƒÉ oferƒÉ protec»õie excelentƒÉ √Æmpotriva obiectelor care cad.',
            'hold-on': '»öin√¢ndu-te de adƒÉpost, acesta rƒÉm√¢ne la locul lui »ôi continuƒÉ sƒÉ te protejeze.',
            'run-outside': 'Alergatul √Æn timpul cutremurului cre»ôte riscul de rƒÉnire din cauza obiectelor care cad.',
            'doorway': 'U»ôile din clƒÉdirile moderne nu sunt mai rezistente dec√¢t alte pƒÉr»õi ale structurii.',
            'elevator': 'Lifturile pot sƒÉ se blocheze √Æn timpul cutremurelor, risc√¢nd sƒÉ rƒÉm√¢i captiv.',
            'move-away-buildings': '√éndepƒÉrtarea de clƒÉdiri reduce riscul de a fi lovit de geamuri sau resturi.',
            'pull-over': 'Tragerea pe dreapta te scoate din trafic »ôi departe de pericole.',
            'stay-in-car': 'Ma»ôina oferƒÉ protec»õie bunƒÉ; ie»ôirea te expune la mai multe pericole.'
        };

        return explanations[actionId] || 'AflƒÉ mai multe despre regulile de siguran»õƒÉ la cutremur.';
    }

    /**
     * Return to scenario selection
     */
    returnToScenarioSelection() {
        document.getElementById('scenario-player').classList.add('hidden');
        document.getElementById('scenario-selector').classList.remove('hidden');
        document.getElementById('feedback-panel').classList.add('hidden');
        document.getElementById('action-panel').classList.remove('hidden');
    }

    /**
     * Activate the scene
     */
    activate() {
        if (typeof audioHelper !== 'undefined' && audioHelper.init) {
            audioHelper.init();
        }
    }

    /**
     * Check if user can proceed to next scene
     */
    canProceed() {
        // User can proceed after completing at least 2 scenarios successfully
        const actions = this.gameState.scenes[this.sceneName].actions;
        const successfulActions = actions.filter(action => 
            action.type === 'earthquake-response' && action.correct
        );
        return successfulActions.length >= 2;
    }

    /**
     * Get current hint for the scene
     */
    getCurrentHint() {
        const completedScenarios = this.gameState.scenes[this.sceneName].actions.length;
        
        if (completedScenarios === 0) {
            return "ExerseazƒÉ scenarii de cutremur pentru a √ÆnvƒÉ»õa rƒÉspunsurile corecte. √éncepe cu un scenariu de interior!";
        } else if (completedScenarios < 2) {
            return "Bun √Ænceput! √éncearcƒÉ scenarii diferite pentru a exersa situa»õii variate de cutremur.";
        } else {
            return "Foarte bine! Ai stƒÉp√¢nit rƒÉspunsul la cutremur. E»ôti pregƒÉtit pentru urmƒÉtoarea etapƒÉ!";
        }
    }
}

// Legacy export for backward compatibility
function showDuringScene() {
    const instructions = `
        <h2>√én timpul cutremului</h2>
        <ul>
            <li>Culcat, Acoperit »ôi »öine-te!</li>
            <li>RƒÉm√¢i √Æn interior dacƒÉ e»ôti √ÆnƒÉuntru.</li>
            <li>Stai departe de feronerie »ôi mobilier greu.</li>
            <li>DacƒÉ e»ôti afarƒÉ, mergi √Æntr-o zonƒÉ deschisƒÉ, departe de clƒÉdiri, copaci »ôi fire electrice.</li>
            <li>DacƒÉ e»ôti la volan, trage pe dreapta √Æntr-un loc sigur »ôi rƒÉm√¢i √Æn ma»ôinƒÉ p√¢nƒÉ se opre»ôte zguduirea.</li>
        </ul>
    `;
    
    document.getElementById('game-container').innerHTML = instructions;
}

export { showDuringScene };